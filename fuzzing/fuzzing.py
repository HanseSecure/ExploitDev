#!/usr/bin/python
'''
Content:	exploitDev fuzzing Helper: Takes a fuzz.spk file from my netstream2spike.py, divided this into seperated files for each request and starts fuzzing with spike
Author: 	Florian Hansemann | @HanseSecure | https://hansesecure.de
Date: 		02/2018

Usage:		python fuzzing.py fuzz.spk

ToDos:      	listening support, udp support, user:passwd support, set target

'''
import optparse, os, subprocess
z = 1

def start(fuzz_input):
    global z

    create_tmp(fuzz_input)
    fuzzing()

def fuzzing():
    global z
    i = 1
    target_ip = "your_Target_IP"
    target_port = "your_Target_Port"
    while i < z:
        print("[+] Reading fuzz_"+str(z-i)+".spk 0 0 [+]")
        subprocess.call(["generic_send_tcp " + target_ip + " " + target_port + " fuzz_"+str(z-i)+".spk 0 0"], shell=True)
        i = i + 1



def create_tmp(fuzz_input):
    global z
    print("[+] Reading fuzz.spk [+]")
    fuzz_file = open(fuzz_input, 'r+')

    for line in fuzz_file:
        if line == '//New requestLine:\n':
            start_line = z + 1
            file_tmp = open("fuzz_" + str(z) + ".spk", 'w')
            z = z + 1

        else:
            file_tmp.write(line)

    return z
'''
    print("[+] Reading fuzz.spk [+]")
    fuzz_file = open(fuzz_input, 'r+')
    z = 0
    lines = []
    for line in fuzz_file:
        if line == '//New requestLine:\n':
            start_line = z + 1
            print ("start "+str(start_line))
            lines.append(start_line)

        else:
            z = z + 1

    for line in fuzz_file:
        
    print(lines)
'''




#	Main Methode
def main():
    parser = optparse.OptionParser('-f <fuzz.spk>')
    parser.add_option('-f', dest='fuzz_input', type='string', help='specify fuzz.spk')
    (options, args) = parser.parse_args()
    fuzz_input = options.fuzz_input
    if os.path.isfile(fuzz_input) == False:
        print ("File does not exists")
    if fuzz_input == None:
        print
        parser.usage
        exit(0)
    start(fuzz_input)


if __name__ == '__main__':
    main()
